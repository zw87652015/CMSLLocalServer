{% extends "base.html" %}

{% block title %}{{ g.get_text('home') }} - {{ g.get_text('title') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-upload me-2"></i>{{ g.get_text('upload_simulation_file') }}</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">{{ g.get_text('select_mph_file') }}</label>
                        <input type="file" class="form-control" id="fileInput" name="file" accept=".mph" required>
                        <div class="form-text">{{ g.get_text('only_mph_format') }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="comsol_version" class="form-label">COMSOL {{ g.get_text('version') }}</label>
                        <select class="form-select" id="comsol_version" name="comsol_version">
                            {% for version, info in g.config.COMSOL_VERSIONS.items() %}
                            <option value="{{ version }}" {% if version == g.config.DEFAULT_COMSOL_VERSION %}selected{% endif %}>
                                {{ info.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">{{ g.get_text('task_priority') }}</label>
                        <select class="form-select" id="priority" name="priority">
                            <option value="normal">{{ g.get_text('normal_priority') }}</option>
                            <option value="high">{{ g.get_text('high_priority') }}</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>{{ g.get_text('upload_and_start') }}
                    </button>
                </form>
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>{{ g.get_text('system_status') }}</h5>
            </div>
            <div class="card-body">
                <div id="systemStats">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number" id="pendingTasks">-</div>
                                <div class="stat-label">{{ g.get_text('pending') }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number" id="runningTasks">-</div>
                                <div class="stat-label">{{ g.get_text('running') }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number text-success" id="completedToday">-</div>
                                <div class="stat-label">{{ g.get_text('completed_today') }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <div class="stat-number text-danger" id="failedToday">-</div>
                                <div class="stat-label">{{ g.get_text('failed_today') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-tasks me-2"></i>{{ g.get_text('my_tasks') }}</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshTasks()">
                    <i class="fas fa-sync-alt"></i> {{ g.get_text('refresh') }}
                </button>
            </div>
            <div class="card-body">
                <div id="tasksContainer">
                    {% if tasks %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>{{ g.get_text('filename') }}</th>
                                        <th>{{ g.get_text('status') }}</th>
                                        <th>{{ g.get_text('priority') }}</th>
                                        <th>{{ g.get_text('progress') }}</th>
                                        <th>{{ g.get_text('created_time') }}</th>
                                        <th>{{ g.get_text('actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTable">
                                    {% for task in tasks %}
                                    <tr>
                                        <td>{{ task.original_filename }}</td>
                                        <td><span class="badge bg-{{ 'success' if task.status == 'completed' else 'danger' if task.status == 'failed' else 'warning' if task.status == 'running' else 'dark' if task.status == 'cancelled' else 'secondary' }}">{{ g.get_text('completed') if task.status == 'completed' else g.get_text('failed') if task.status == 'failed' else g.get_text('running') if task.status == 'running' else g.get_text('cancelled') if task.status == 'cancelled' else g.get_text('queued') if task.status == 'queued' else g.get_text('pending_status') }}</span></td>
                                        <td><span class="badge bg-{{ 'danger' if task.priority == 'high' else 'primary' }}">{{ g.get_text('high') if task.priority == 'high' else g.get_text('normal') }}</span></td>
                                        <td>
                                            <div class="progress task-progress">
                                                <div class="progress-bar bg-{{ 'success' if task.status == 'completed' else 'danger' if task.status == 'failed' else 'warning' }}" 
                                                     role="progressbar" aria-valuenow="{{ task.progress_percentage }}" aria-valuemin="0" aria-valuemax="100"
                                                     data-width="{{ task.progress_percentage }}">
                                                    {{ task.progress_percentage }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if task.result_filename %}
                                            <a href="{{ url_for('download_result', task_id=task.id) }}" class="btn btn-sm btn-success me-1">
                                                <i class="fas fa-download"></i> {{ g.get_text('download') }}
                                            </a>
                                            {% endif %}
                                            {% if task.status in ['pending', 'queued', 'running'] %}
                                            <button class="btn btn-sm btn-warning me-1" onclick="cancelTask('{{ task.id }}')" title="{{ g.get_text('cancel_task') }}">
                                                <i class="fas fa-stop"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-info me-1" onclick="viewLogs('{{ task.id }}')">
                                                <i class="fas fa-file-alt"></i> {{ g.get_text('logs') }}
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteTask('{{ task.id }}')" title="{{ g.get_text('delete_task') }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>{{ g.get_text('no_tasks') }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Modal -->
<div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ g.get_text('task_logs') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="logContent" class="bg-dark text-light p-3 log-content"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh system stats and tasks
setInterval(updateSystemStats, 5000);
setInterval(refreshTasks, 10000);

// Initial load
updateSystemStats();
</script>
{% endblock %}
